name: WFSL Promotion Gate

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  promotion-gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout governance ledger
        uses: actions/checkout@v4
        with:
          repository: Wynergy-Fibre-Solutions/wfsl-catalogue-migration
          path: governance

      - name: Verify frozen attestation schema (v1)
        run: |
          set -e

          EXPECTED_HASH="PUT_FULL_SHA256_HERE"

          ACTUAL_HASH=$(sha256sum governance/verification/ATTESTATION_SCHEMA.md | awk '{print $1}')

          if [ "$EXPECTED_HASH" != "$ACTUAL_HASH" ]; then
            echo "ERROR: Frozen attestation schema hash mismatch"
            echo "Expected: $EXPECTED_HASH"
            echo "Actual:   $ACTUAL_HASH"
            exit 1
          fi

          echo "OK: Frozen attestation schema verified"

      - name: Verify promotion decision (single or batch v1.1)
        run: |
          set -e

          if [ -f governance/verification/DECISION_BATCH_V11.json ]; then
            echo "OK: Batch promotion decision v1.1 present"
            exit 0
          fi

          if [ -f governance/verification/DECISION_TRANSFER_APPROVED.json ]; then
            echo "OK: Single promotion decision present"
            exit 0
          fi

          echo "ERROR: No valid promotion decision found"
          exit 1

      - name: Promotion gate passed
        run: |
          echo "PROMOTION APPROVED â€” governance conditions satisfied"
